#!/bin/bash

main() {
    parse $*
    load "${args[@]}"
    validate
    run
    if [ $? -ne 0 ]; then exit 500; fi
    exit 0
}
parse() {
    args=()

    for arg in $@; do
        case $arg in
        --debug)
            LDT_DEBUG_MODE=true
            ;;
        *)
            args+=($arg)
            ;;
        esac
    done
}
load() {
    ## load:variables
    ldt_cmd=$1
    shift

    ## load:environment
    if [ -f $ldt_workindDir/.env ]; then
        export $(cat $ldt_workindDir/.env | xargs)
    fi
    if [ -f $ldt_workindDir/ldt.env ]; then
        export $(cat $ldt_workindDir/ldt.env | xargs)
    fi

    ## load:logger
    logger="eval echo"
    if [ ! "$(command -v ldtl)" = "" ]; then logger=ldtl; fi
    if [ ! "$(command -v $ldtl)" = "" ]; then logger=$ldtl; fi
    if [ ! "$(command -v ldt-logger)" = "" ]; then logger=ldt-logger; fi
    if [ ! "$(command -v ldtLogger)" = "" ]; then logger=ldtLogger; fi
    LDT_LOGGER_LOGPREFIX=" LDT"
    if [ "$LDT_DEBUG_MODE" = "true" ]; then
        LDT_LOGGER_LOGLEVEL=DEBUG
    else
        LDT_LOGGER_LOGLEVEL=WARN
    fi
    export LDT_LOGGER_LOGPREFIX
    export LDT_LOGGER_LOGLEVEL
}
validate() {
    ## validate:command
    if [ "$ldt_cmd" = "" ]; then ldt_cmd=run; fi
    if [ "$ldt_cmd" = "-h" ]; then ldt_cmd=usage; fi
    if [ "$ldt_cmd" = "--help" ]; then ldt_cmd=usage; fi
    if [ "$ldt_cmd" = "-u" ]; then ldt_cmd=usage; fi
    if [ "$ldt_cmd" = "--usage" ]; then ldt_cmd=usage; fi
    if [ "$ldt_cmd" = "-v" ]; then ldt_cmd=version; fi
    if [ "$ldt_cmd" = "--version" ]; then ldt_cmd=version; fi

    if [ ! "$ldt_cmd" = "version" ] &&
        [ ! "$ldt_cmd" = "usage" ]; then
        $logger logError "Unknown command!"
        $logger logDebug "-- cause: ldt_cmd=$ldt_cmd"
        exit 400
    fi
}
run() {
    if [ "$ldt_cmd" = "version" ]; then doPrintVersion; fi
    if [ "$ldt_cmd" = "usage" ]; then doPrintUsage; fi
    if [ "$ldt_cmd" = "run" ]; then doRunCommand; fi
}
doPrintUsage() {
echo "=============================================
USAGE: ldt <task> [args]

tasks:
  usage             -  prints the usage informations to the console
  version           -  prints the app-version to the console

args:
  --debug           -  allow to print more informative debug informations to the console
"
}
doPrintVersion() {
echo "ldt v1.0.0-SNAPSHOT"
}
doRunCommand() {
    $logger logDebug "TODO: doRunCommand"
}
main $*
